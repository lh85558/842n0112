name: Build OpenWrt for TP842NV3

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up environment
      run: |
        sudo apt-get update
        sudo apt upgrade
        sudo apt-get install -y build-essential subversion libncurses5-dev zlib1g-dev gawk gcc-multilib flex git-core gettext libssl-dev unzip 2to3 python2 python-is-python3 python3
        sudo timedatectl set-timezone Asia/Shanghai

    - name: Update feeds
      run: |
        echo "src-git packages https://mirrors.tuna.tsinghua.edu.cn/openwrt/packages.git"
        echo "src-git luci https://mirrors.tuna.tsinghua.edu.cn/openwrt/luci.git"
        echo "src-git routing https://mirrors.tuna.tsinghua.edu.cn/openwrt/routing.git"
        echo "src-git telephony https://mirrors.tuna.tsinghua.edu.cn/openwrt/telephony.git"
        echo "src-git targets https://mirrors.tuna.tsinghua.edu.cn/openwrt/targets.git"
        echo "src-git oldpackages http://mirror2.openwrt.org/oldpackages.git"
        echo "src-git custom https://github.com/immortalwrt/packages.git"
        cat > feeds.conf << 'EOF'
        src-git packages https://mirrors.tuna.tsinghua.edu.cn/openwrt/packages.git
        src-git luci https://mirrors.tuna.tsinghua.edu.cn/openwrt/luci.git
        src-git routing https://mirrors.tuna.tsinghua.edu.cn/openwrt/routing.git
        src-git telephony https://mirrors.tuna.tsinghua.edu.cn/openwrt/telephony.git
        EOF
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Configure TP842NV3 device
      run: |
        cat > .config << 'EOF'
        CONFIG_TARGET_ath79=y
        CONFIG_TARGET_ath79_generic=y
        CONFIG_TARGET_ath79_generic_DEVICE_tplink_tl-wr842n-v3=y
        CONFIG_TARGET_ROOTFS_PARTSIZE=16384
        CONFIG_TARGET_KERNEL_PARTSIZE=2048
        EOF

    - name: Configure packages
      run: |
        cat >> .config << 'EOF'
        # CUPS打印服务
        CONFIG_PACKAGE_cups=y
        CONFIG_PACKAGE_cups-bjnp=y
        CONFIG_PACKAGE_cups-filters=y
        CONFIG_PACKAGE_cups-pdf=y
        CONFIG_PACKAGE_cups-driver-gutenprint=y
        CONFIG_PACKAGE_foomatic-filters=y
        CONFIG_PACKAGE_ghostscript=y

        # USB打印支持
        CONFIG_PACKAGE_usb-printer=y
        CONFIG_PACKAGE_kmod-usb-printer=y
        CONFIG_PACKAGE_kmod-usb-core=y
        CONFIG_PACKAGE_kmod-usb2=y
        CONFIG_PACKAGE_kmod-usb3=y

        # 局域网共享
        CONFIG_PACKAGE_samba4-server=y
        CONFIG_PACKAGE_samba4-client=y
        CONFIG_PACKAGE_samba4-libs=y

        # 定时重启
        CONFIG_PACKAGE_cron=y
        CONFIG_PACKAGE_crond=y

        # 无线功能
        CONFIG_PACKAGE_wireless-tools=y
        CONFIG_PACKAGE_hostapd-common=y
        CONFIG_PACKAGE_wpa-supplicant=y

        # 中文支持
        CONFIG_PACKAGE_luci-i18n-base-zh-cn=y
        CONFIG_PACKAGE_luci-i18n-cups-zh-cn=y
        CONFIG_PACKAGE_luci-i18n-samba4-zh-cn=y

        # Web管理界面
        CONFIG_PACKAGE_luci=y
        CONFIG_PACKAGE_luci-theme-bootstrap=y
        CONFIG_PACKAGE_luci-app-firewall=y
        CONFIG_PACKAGE_luci-app-opkg=y
        CONFIG_PACKAGE_luci-app-system=y
        CONFIG_PACKAGE_luci-app-network=y
        CONFIG_PACKAGE_luci-app-wireless=y
        EOF

    - name: Customize configuration
      run: |
        cat >> .config << 'EOF'
        # 系统配置
        CONFIG_HOSTNAME="TP842NV3"
        CONFIG_PASSWORD="thdn12345678"
        CONFIG_IPADDR="192.168.10.1"
        CONFIG_NETMASK="255.255.255.0"
        CONFIG_GATEWAY="192.168.10.1"
        CONFIG_DNS="114.114.114.114 114.114.115.115"

        # 无线配置
        CONFIG_WIFI_SSID="THDN-Print"
        CONFIG_WIFI_PASSWORD="thdn12345678"
        CONFIG_WIFI_CHANNEL="auto"
        CONFIG_WIFI_HTMODE="HT20"
        CONFIG_WIFI_COUNTRY="CN"
        EOF

    - name: Build firmware
      run: |
        make defconfig
        make download -j8
        make -j$(nproc)

    - name: Prepare output
      run: |
        mkdir -p firmware
        cp -f bin/targets/ath79/generic/*.bin firmware/
        ls -la firmware/
        echo "Firmware built successfully!"
        echo "BIN files are available in the firmware directory:"
