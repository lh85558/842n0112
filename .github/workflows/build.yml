name: Build OpenWrt for TP842NV3

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up environment
      run: |
        sudo apt-get update
        sudo apt-get upgrade -y
        sudo apt-get install -y build-essential subversion libncurses5-dev zlib1g-dev gawk gcc-multilib flex git-core gettext libssl-dev unzip 2to3 python2 python-is-python3
        sudo timedatectl set-timezone Asia/Shanghai

    - name: Clone OpenWrt source
      run: |
        git clone -b openwrt-21.02 https://github.com/openwrt/openwrt.git openwrt-source

    - name: Update feeds
      working-directory: ./openwrt-source
      run: |
        # 备份原始feeds.conf
        if [ -f feeds.conf ]; then
          mv feeds.conf feeds.conf.bak
        fi
        # 创建新的feeds.conf文件，使用国内镜像源
        echo "src-git packages https://mirrors.tuna.tsinghua.edu.cn/openwrt/packages.git;openwrt-21.02" > feeds.conf
        echo "src-git luci https://mirrors.tuna.tsinghua.edu.cn/openwrt/luci.git;openwrt-21.02" >> feeds.conf
        echo "src-git routing https://mirrors.tuna.tsinghua.edu.cn/openwrt/routing.git;openwrt-21.02" >> feeds.conf
        # 移除有问题的telephony feed
        # 尝试更新feeds，忽略失败
        ./scripts/feeds update -a || true
        # 安装必要的feeds
        ./scripts/feeds install -a || ./scripts/feeds install packages luci routing

    - name: Configure QCA9533 device
      working-directory: ./openwrt-source
      run: |
        echo "CONFIG_TARGET_ath79=y" > .config
        echo "CONFIG_TARGET_ath79_generic=y" >> .config
        echo "CONFIG_TARGET_ath79_generic_DEVICE_generic_qca9533=y" >> .config
        echo "CONFIG_TARGET_ROOTFS_PARTSIZE=16384" >> .config
        echo "CONFIG_TARGET_KERNEL_PARTSIZE=2048" >> .config

    - name: Configure packages
      working-directory: ./openwrt-source
      run: |
        echo "# CUPS打印服务" >> .config
        echo "CONFIG_PACKAGE_cups=y" >> .config
        echo "CONFIG_PACKAGE_cups-bjnp=y" >> .config
        echo "CONFIG_PACKAGE_cups-filters=y" >> .config
        echo "CONFIG_PACKAGE_cups-pdf=y" >> .config
        echo "CONFIG_PACKAGE_cups-driver-gutenprint=y" >> .config
        echo "CONFIG_PACKAGE_foomatic-filters=y" >> .config
        echo "CONFIG_PACKAGE_ghostscript=y" >> .config
        echo "" >> .config
        echo "# USB打印支持" >> .config
        echo "CONFIG_PACKAGE_usb-printer=y" >> .config
        echo "CONFIG_PACKAGE_kmod-usb-printer=y" >> .config
        echo "CONFIG_PACKAGE_kmod-usb-core=y" >> .config
        echo "CONFIG_PACKAGE_kmod-usb2=y" >> .config
        echo "CONFIG_PACKAGE_kmod-usb3=y" >> .config
        echo "" >> .config
        echo "# 局域网共享" >> .config
        echo "CONFIG_PACKAGE_samba4-server=y" >> .config
        echo "CONFIG_PACKAGE_samba4-client=y" >> .config
        echo "CONFIG_PACKAGE_samba4-libs=y" >> .config
        echo "" >> .config
        echo "# 定时重启" >> .config
        echo "CONFIG_PACKAGE_cron=y" >> .config
        echo "CONFIG_PACKAGE_crond=y" >> .config
        echo "" >> .config
        echo "# 无线功能" >> .config
        echo "CONFIG_PACKAGE_wireless-tools=y" >> .config
        echo "CONFIG_PACKAGE_hostapd-common=y" >> .config
        echo "CONFIG_PACKAGE_wpa-supplicant=y" >> .config
        echo "" >> .config
        echo "# 中文支持" >> .config
        echo "CONFIG_PACKAGE_luci-i18n-base-zh-cn=y" >> .config
        echo "CONFIG_PACKAGE_luci-i18n-cups-zh-cn=y" >> .config
        echo "CONFIG_PACKAGE_luci-i18n-samba4-zh-cn=y" >> .config
        echo "" >> .config
        echo "# Web管理界面" >> .config
        echo "CONFIG_PACKAGE_luci=y" >> .config
        echo "CONFIG_PACKAGE_luci-theme-bootstrap=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-firewall=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-opkg=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-system=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-network=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-wireless=y" >> .config

    - name: Customize configuration
      working-directory: ./openwrt-source
      run: |
        mkdir -p files/etc/config
        mkdir -p files/etc/crontabs
        
        # 网络配置
        echo 'config interface "loopback"' > files/etc/config/network
        echo '    option device "lo"' >> files/etc/config/network
        echo '    option proto "static"' >> files/etc/config/network
        echo '    option ipaddr "127.0.0.1"' >> files/etc/config/network
        echo '    option netmask "255.0.0.0"' >> files/etc/config/network
        echo '' >> files/etc/config/network
        echo 'config interface "lan"' >> files/etc/config/network
        echo '    option device "br-lan"' >> files/etc/config/network
        echo '    option proto "static"' >> files/etc/config/network
        echo '    option ipaddr "192.168.10.1"' >> files/etc/config/network
        echo '    option netmask "255.255.255.0"' >> files/etc/config/network
        echo '    option ip6assign "60"' >> files/etc/config/network
        echo '' >> files/etc/config/network
        echo 'config device "br-lan"' >> files/etc/config/network
        echo '    option type "bridge"' >> files/etc/config/network
        echo '    list ports "eth0"' >> files/etc/config/network
        
        # 无线配置
        echo 'config wifi-device "radio0"' > files/etc/config/wireless
        echo '    option type "mac80211"' >> files/etc/config/wireless
        echo '    option path "platform/ar933x_wmac"' >> files/etc/config/wireless
        echo '    option channel "auto"' >> files/etc/config/wireless
        echo '    option band "2g"' >> files/etc/config/wireless
        echo '    option htmode "HT20"' >> files/etc/config/wireless
        echo '    option country "CN"' >> files/etc/config/wireless
        echo '' >> files/etc/config/wireless
        echo 'config wifi-iface "default_radio0"' >> files/etc/config/wireless
        echo '    option device "radio0"' >> files/etc/config/wireless
        echo '    option network "lan"' >> files/etc/config/wireless
        echo '    option mode "ap"' >> files/etc/config/wireless
        echo '    option ssid "THDN-Print"' >> files/etc/config/wireless
        echo '    option encryption "psk2"' >> files/etc/config/wireless
        echo '    option key "thdn12345678"' >> files/etc/config/wireless
        
        # 定时重启
        echo '0 3 * * * /sbin/reboot' > files/etc/crontabs/root
        
        # 系统配置
        echo 'CONFIG_TARGET_ROOTFS_PARTSIZE=16384' >> .config
        echo 'CONFIG_TARGET_KERNEL_PARTSIZE=2048' >> .config
        echo 'CONFIG_HOSTNAME="TP842NV3"' >> .config
        echo 'CONFIG_PASSWORD="thdn12345678"' >> .config

    - name: Build firmware
      working-directory: ./openwrt-source
      run: |
        make defconfig
        make download -j8
        make -j$(nproc) V=s

    - name: Prepare output
      run: |
        mkdir -p firmware
        cp -f openwrt-source/bin/targets/ath79/generic/*.bin firmware/
        ls -la firmware/
        echo "Firmware built successfully!"
        echo "BIN files are available in the firmware directory:"

    - name: Upload firmware
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-firmware
        path: firmware/*.bin
        retention-days: 30
